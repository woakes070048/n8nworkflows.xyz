{"id":"tgUy8qbiSc3uSHuX","meta":{"instanceId":"89b251c2077923dfcf09df1af042f7170f6404c508d45b4769b8a7966f5bd226"},"name":"ğŸ¤– AgentGatePay - Buyer Agent MCP [TEMPLATE]","tags":[],"nodes":[{"id":"92e66d1d-f0f5-4d1e-96cd-aec1f1916e7d","name":"â–¶ï¸ START","type":"n8n-nodes-base.manualTrigger","position":[608,336],"parameters":{},"typeVersion":1},{"id":"5d3971b4-3854-40d0-b967-51c245a8dec1","name":"1ï¸âƒ£ Load Config","type":"n8n-nodes-base.code","position":[816,336],"parameters":{"jsCode":"const CONFIG = {\n  buyer: {\n    name: \"Research Assistant AI\",\n    company: \"Your Company\",\n    email: \"user@example.com\",  // âš ï¸ REPLACE: Your buyer agent email\n    task: \"Analyze top 5 competitors in SaaS market\",\n    api_key: \"YOUR_AGENTGATEPAY_API_KEY\",  // âš ï¸ REPLACE: From AgentGatePay signup\n    budget_usd: 100,\n    mandate_ttl_days: 7,\n    mandate_scope: \"resource.read payment.execute\"\n  },\n  seller: {\n    name: \"DataBot Pro\",\n    company: \"MarketInsights AI Ltd.\",\n    email: \"user@example.com\",\n    service: \"Premium Market Research Reports\",\n    api_url: \"https://YOUR_N8N.app.n8n.cloud/webhook/seller-resource-api-test\",  // âš ï¸ REPLACE: Seller webhook URL\n    selected_resource_id: \"saas-competitors-2025\"\n  },\n  render: {\n    service_url: \"https://YOUR_RENDER_APP.onrender.com\"\n  },\n  blockchain: {\n    chain: \"base\",\n    token: \"USDC\",\n    rpc_url: \"https://mainnet.base.org\"\n  },\n  agentgatepay: {\n    api_url: \"https://api.agentgatepay.com\",\n    mcp_endpoint: \"https://mcp.agentgatepay.com\"\n  }\n};\n\nreturn [{json: {config: CONFIG, session: {id: `session_${Date.now()}`, started_at: new Date().toISOString(), agent: CONFIG.buyer.email}}}];"},"typeVersion":2},{"id":"f9512e04-334e-4d81-9e99-90c3d89c9a3f","name":"2ï¸âƒ£ ğŸ“Š Get Mandate Token","type":"n8n-nodes-base.dataTable","notes":"ğŸ” CHECK: Does mandate exist?\n\nâš ï¸ CONFIGURE: You MUST select 'AgentPay_Mandates' from dropdown!\n\nClick this node â†’ Data table dropdown â†’ Select AgentPay_Mandates â†’ Save","position":[1024,336],"parameters":{"operation":"get","returnAll":true,"dataTableId":{"__rl":true,"mode":"list","value":"0RVPG9hWFRYnyUw7","cachedResultUrl":"/projects/GLZPTknscCLLXTgj/datatables/0RVPG9hWFRYnyUw7","cachedResultName":"AgentPay_Mandates"}},"typeVersion":1,"continueOnFail":true,"alwaysOutputData":true},{"id":"64fe4d58-91f7-41fd-a5a0-87ec24b44e6d","name":"2Bï¸âƒ£ Normalize Result","type":"n8n-nodes-base.code","notes":"ğŸ”„ NORMALIZE: Handle empty table\n\nIf table empty â†’ Pass { mandate_token: null }\nIf table has row â†’ Pass the row data\n\nThis ensures Node 3 always receives data!","position":[1232,336],"parameters":{"jsCode":"// Normalize Data Table output\n// When table is empty, create empty object\n// When table has row, pass it through\n\nconst config = $('1ï¸âƒ£ Load Config').first().json.config;\n\nif ($input.all().length === 0) {\n  // Table is empty - return EMPTY STRING (not null)\n  console.log('ğŸ“Š Data Table is empty - returning empty string');\n  return [{ json: { mandate_token: '', config: config } }];\n}\n\n// Table has data - pass it through with config\nconst allRows = $input.all();\nconsole.log(`ğŸ“Š Data Table returned ${allRows.length} row(s)`);\n\nif (allRows.length > 1) {\n  console.warn('âš ï¸ WARNING: Multiple rows found! Using first row only.');\n}\n\nconst tableData = $input.first().json;\nconsole.log(`   mandate_token: ${tableData.mandate_token ? tableData.mandate_token.substring(0, 30) + '...' : 'EMPTY/NULL'}`);\n\nreturn [{ json: { ...tableData, config: config } }];"},"typeVersion":2},{"id":"2b833bcc-d396-4680-b313-0a1d4941cb74","name":"3ï¸âƒ£ Has Token?","type":"n8n-nodes-base.if","notes":"ğŸ”€ ROUTER:\n\nTRUE â†’ Token exists â†’ Verify it\nFALSE â†’ No token â†’ Create new mandate","position":[1440,336],"parameters":{"options":{},"conditions":{"options":{"version":1,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"has-token","operator":{"type":"string","operation":"notEmpty"},"leftValue":"={{ $json.mandate_token }}","rightValue":""}]}},"typeVersion":2},{"id":"09934b2c-4f43-4d94-9952-93f22fd20353","name":"4ï¸âƒ£ âœ… Verify Existing Token","type":"n8n-nodes-base.httpRequest","notes":"ğŸ”’ ASK GATEWAY: Is this token still valid?\n\nGateway checks:\nâœ… Signature valid?\nâœ… Not expired?\nâœ… Budget remaining?\nâœ… Scope correct?\n\nGateway = Source of Truth!","position":[1696,192],"parameters":{"url":"={{ $('1ï¸âƒ£ Load Config').first().json.config.agentgatepay.mcp_endpoint }}","method":"POST","options":{},"jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"id\": 3,\n  \"method\": \"tools/call\",\n  \"params\": {\n    \"name\": \"agentpay_verify_mandate\",\n    \"arguments\": {\n      \"mandate_token\": \"{{ $json.mandate_token }}\"\n    }\n  }\n}","sendBody":true,"sendHeaders":true,"specifyBody":"json","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"x-api-key","value":"={{ $('1ï¸âƒ£ Load Config').first().json.config.buyer.api_key }}"}]}},"typeVersion":4.2},{"id":"9e9e0ede-81f8-472b-9364-5069045cfbf3","name":"4Bï¸âƒ£ Check Verification","type":"n8n-nodes-base.code","notes":"ğŸ” PARSE GATEWAY RESPONSE:\n\nâœ… Valid â†’ Continue with existing mandate\nâŒ Invalid â†’ ERROR with clear renewal instructions\n\nNEVER auto-renews! Security by design!","position":[1904,192],"parameters":{"jsCode":"const verify_response = $input.first().json;\nconst config = $('1ï¸âƒ£ Load Config').first().json.config;\nconst stored_token = $('2ï¸âƒ£ ğŸ“Š Get Mandate Token').first().json.mandate_token;\n\n// Parse MCP response\nif (!verify_response.result || !verify_response.result.content) {\n  throw new Error('âŒ Gateway verification failed - invalid response');\n}\n\nconst text = verify_response.result.content[0].text;\nconst verification = JSON.parse(text);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸš¨ MANDATE EXPIRED OR INVALID - SHOW CLEAR INSTRUCTIONS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nif (!verification.valid) {\n  const errorMsg = `\nğŸš¨ MANDATE EXPIRED OR INVALID!\n\n${verification.error || 'Mandate is no longer valid'}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“‹ TO CREATE NEW MANDATE (2 STEPS):\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n1ï¸âƒ£ Delete the token from storage:\n   â€¢ Go to: Data â†’ AgentPay_Mandates\n   â€¢ Click the row\n   â€¢ Click Delete (trash icon)\n   â€¢ Click Confirm\n\n2ï¸âƒ£ Run this workflow again:\n   â€¢ Will automatically create fresh mandate\n   â€¢ New $${config.buyer.budget_usd} budget allocated\n   â€¢ 7-day validity period\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ’¡ WHY THIS HAPPENS:\nMandates have limited budget/time by design.\nThis is a SECURITY FEATURE to prevent unlimited spending.\n\nWhen budget depleted or time expired, you must\nmanually approve a new mandate.\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n  `;\n  \n  throw new Error(errorMsg);\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// âœ… MANDATE VALID - CONTINUE WITH EXISTING TOKEN\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconsole.log('â™»ï¸ REUSING EXISTING MANDATE!');\nconsole.log(`   Budget Remaining: $${verification.budget_remaining}`);\nconsole.log(`   TTL Remaining: ${verification.ttl_remaining_hours} hours`);\nconsole.log(`   Status: ${verification.status}`);\n\nconst mandate = {\n  token: stored_token,\n  id: verification.mandate_id || 'unknown',\n  budget_remaining: verification.budget_remaining,\n  ttl_hours: verification.ttl_remaining_hours,\n  status: verification.status\n};\n\nreturn [{\n  json: {\n    config,\n    mandate,\n    verification,\n    was_reused: true,\n    source: 'existing_token',\n    message: `â™»ï¸ REUSING MANDATE!\\n\\nBudget: $${verification.budget_remaining}\\nTTL: ${verification.ttl_remaining_hours} hours\\nStatus: ${verification.status}`\n  }\n}];"},"typeVersion":2},{"id":"075f1847-da02-4a80-907a-0c978ea1d619","name":"5ï¸âƒ£ ğŸ†• Create New Mandate","type":"n8n-nodes-base.httpRequest","notes":"ğŸ†• CREATE: New mandate via Gateway API\n\nOnly runs when:\n- First time (no token in table)\n- OR user deleted token (manual renewal)\n\nNEVER auto-creates on expiry!","position":[1696,480],"parameters":{"url":"={{ $('1ï¸âƒ£ Load Config').first().json.config.agentgatepay.mcp_endpoint }}","method":"POST","options":{},"jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"id\": 1,\n  \"method\": \"tools/call\",\n  \"params\": {\n    \"name\": \"agentpay_issue_mandate\",\n    \"arguments\": {\n      \"subject\": \"{{ $('1ï¸âƒ£ Load Config').first().json.config.buyer.email }}\",\n      \"budget_usd\": {{ $('1ï¸âƒ£ Load Config').first().json.config.buyer.budget_usd }},\n      \"scope\": \"{{ $('1ï¸âƒ£ Load Config').first().json.config.buyer.mandate_scope }}\",\n      \"ttl_minutes\": {{ $('1ï¸âƒ£ Load Config').first().json.config.buyer.mandate_ttl_days * 1440 }}\n    }\n  }\n}","sendBody":true,"sendHeaders":true,"specifyBody":"json","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"x-api-key","value":"={{ $('1ï¸âƒ£ Load Config').first().json.config.buyer.api_key }}"}]}},"typeVersion":4.2},{"id":"8ae0aef5-0581-45f9-8aed-ee291f01fe6c","name":"5Bï¸âƒ£ Parse New Mandate","type":"n8n-nodes-base.code","notes":"ğŸ“¦ EXTRACT: Token from API response\n\nNext: VERIFY this new token works before saving!","position":[1904,480],"parameters":{"jsCode":"const api_response = $input.first().json;\nconst config = $('1ï¸âƒ£ Load Config').first().json.config;\n\nif (!api_response.result || !api_response.result.content) {\n  throw new Error('âŒ Failed to create mandate - invalid API response');\n}\n\nconst text = api_response.result.content[0].text;\nconst result = JSON.parse(text);\n\nif (!result.mandate_token) {\n  throw new Error('âŒ API did not return mandate_token');\n}\n\nconsole.log('ğŸ†• NEW MANDATE CREATED!');\nconsole.log(`   Mandate ID: ${result.mandate_id}`);\nconsole.log(`   Token: ${result.mandate_token.substring(0, 20)}...`);\nconsole.log(`   Budget: $${result.budget_remaining || config.buyer.budget_usd}`);\nconsole.log(`   Expires: ${result.expires_at}`);\nconsole.log('   âœ… Will be saved to table');\n\nconst mandate = {\n  token: result.mandate_token,\n  id: result.mandate_id,\n  budget_remaining: parseFloat(result.budget_remaining || config.buyer.budget_usd),\n  expires_at: result.expires_at\n};\n\nreturn [{\n  json: {\n    config,\n    mandate,\n    verification: {\n      valid: true,\n      budget_remaining: mandate.budget_remaining,\n      status: 'active'\n    },\n    was_reused: false,\n    source: 'new_mandate',\n    message: `ğŸ†• NEW MANDATE!\\n\\nID: ${mandate.id}\\nBudget: $${mandate.budget_remaining}\\nExpires: ${mandate.expires_at}`\n  }\n}];"},"typeVersion":2},{"id":"c698bfa3-31df-4d15-b853-fbae8b6dc95f","name":"6ï¸âƒ£ âœ… Verify New Mandate","type":"n8n-nodes-base.httpRequest","notes":"ğŸ”’ VERIFY: New mandate works!\n\nDon't save broken tokens to table.\nGateway confirms it's valid before we store it.","position":[2112,480],"parameters":{"url":"={{ $('1ï¸âƒ£ Load Config').first().json.config.agentgatepay.mcp_endpoint }}","method":"POST","options":{},"jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"id\": 4,\n  \"method\": \"tools/call\",\n  \"params\": {\n    \"name\": \"agentpay_verify_mandate\",\n    \"arguments\": {\n      \"mandate_token\": \"{{ $json.mandate.token }}\"\n    }\n  }\n}","sendBody":true,"sendHeaders":true,"specifyBody":"json","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"x-api-key","value":"={{ $('1ï¸âƒ£ Load Config').first().json.config.buyer.api_key }}"}]}},"typeVersion":4.2},{"id":"e6648b7b-da08-4471-a8c9-d3022cb6dae5","name":"6Bï¸âƒ£ Check New Mandate","type":"n8n-nodes-base.code","notes":"âœ… CHECK: New mandate is valid\n\nIf invalid â†’ ERROR (don't save)\nIf valid â†’ Prepare token for saving","position":[2320,480],"parameters":{"jsCode":"const verify_response = $input.first().json;\nconst parsed_data = $('5Bï¸âƒ£ Parse New Mandate').first().json;\nconst config = $('1ï¸âƒ£ Load Config').first().json.config;\n\n// Parse MCP response\nif (!verify_response.result || !verify_response.result.content) {\n  throw new Error('âŒ Gateway verification failed - invalid response');\n}\n\nconst text = verify_response.result.content[0].text;\nconst verification = JSON.parse(text);\n\nif (!verification.valid) {\n  throw new Error(`âŒ New mandate is INVALID: ${verification.error || 'Unknown error'}`);\n}\n\nconst token = parsed_data.mandate.token;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ›¡ï¸ STRICT VALIDATION - PREVENT NULL/INVALID TOKENS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Check 1: Exists and is a string\nif (!token || typeof token !== 'string') {\n  throw new Error('âŒ BLOCKED: Token is missing or not a string!');\n}\n\n// Check 2: Not literal 'null' or 'undefined' strings\nif (token === 'null' || token === 'undefined' || token === '') {\n  throw new Error('âŒ BLOCKED: Token is null, undefined, or empty string!');\n}\n\n// Check 3: Minimum length (JWT tokens are 100+ chars)\nif (token.length < 50) {\n  throw new Error(`âŒ BLOCKED: Token too short (${token.length} chars) - likely invalid!`);\n}\n\n// Check 4: Must contain periods (JWT format: header.payload.signature)\nif (!token.includes('.')) {\n  throw new Error('âŒ BLOCKED: Token is not in JWT format (missing periods)!');\n}\n\nconsole.log('âœ… New mandate verified successfully!');\nconsole.log(`   Token: ${token.substring(0, 30)}...`);\nconsole.log(`   Token length: ${token.length} chars`);\nconsole.log(`   Budget: $${verification.budget_remaining}`);\nconsole.log(`   Status: ${verification.status}`);\nconsole.log('   ğŸ›¡ï¸ Validation: ALL CHECKS PASSED');\n\n// Prepare for saving to table\nreturn [{\n  json: {\n    mandate_token: token,\n    _original_data: parsed_data  // Keep for Node 7B\n  }\n}];"},"typeVersion":2},{"id":"18397ef6-45a5-49ba-9f8a-af2af960f664","name":"7ï¸âƒ£ ğŸ’¾ Insert Token","type":"n8n-nodes-base.dataTable","notes":"ğŸ’¾ INSERT: Verified token to table\n\nReceives: { mandate_token: \"...\" }\nAuto-maps to table column\n\nOnly saves tokens that passed verification!\n\nâš ï¸ IMPORTANT: RE-SELECT 'AgentPay_Mandates' from dropdown!","position":[2528,480],"parameters":{"columns":{"value":{"mandate_token":"={{ $json.mandate_token }}"},"schema":[{"id":"mandate_token","type":"string","display":true,"removed":false,"readOnly":false,"required":false,"displayName":"mandate_token","defaultMatch":false}],"mappingMode":"defineBelow","matchingColumns":[],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{},"dataTableId":{"__rl":true,"mode":"list","value":"0RVPG9hWFRYnyUw7","cachedResultUrl":"/projects/GLZPTknscCLLXTgj/datatables/0RVPG9hWFRYnyUw7","cachedResultName":"AgentPay_Mandates"}},"typeVersion":1},{"id":"ce95fef9-8a7c-44d4-a56f-80d2b8a2054c","name":"7Bï¸âƒ£ Restore Data","type":"n8n-nodes-base.code","notes":"ğŸ”„ RESTORE: Original data structure\n\nNode 7 returns table response\nNode 8 needs original mandate data\n\nThis bridges the gap.","position":[2720,480],"parameters":{"jsCode":"// Restore original data for merge node\nconst table_response = $input.first().json;\nconst original_data = $('6Bï¸âƒ£ Check New Mandate').first().json._original_data;\n\nconsole.log('âœ… Token saved to table successfully!');\n\n// Return original mandate data for Node 8\nreturn [{ json: original_data }];"},"typeVersion":2},{"id":"98ce0832-7986-4700-9731-eebdf91742bd","name":"8ï¸âƒ£ ğŸ”€ Merge Paths","type":"n8n-nodes-base.code","notes":"ğŸ”€ MERGE: Both paths converge here\n\nPath 1: Verified existing token â™»ï¸\nPath 2: Created new token ğŸ†•\n\nBoth continue with same flow","position":[2112,192],"parameters":{"jsCode":"// Both paths merge here (existing token or new token)\nconst data = $input.first().json;\n\nconst config = data.config;\nconst session = $('1ï¸âƒ£ Load Config').first().json.session;\nconst mandate = data.mandate;\nconst verification = data.verification;\n\nconst merchant = config.seller;\n\nconst selected_resource = {\n  id: merchant.selected_resource_id,\n  title: \"SaaS Competitor Analysis 2025\",\n  description: \"Top 5 competitors analysis\"\n};\n\nconst resource_request = {\n  from: config.buyer.email,\n  to: merchant.email,\n  resource_id: selected_resource.id,\n  resource_title: selected_resource.title,\n  mandate_token: mandate.token,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{\n  json: {\n    config,\n    session,\n    mandate,\n    verification,\n    was_reused: data.was_reused,\n    merchant: merchant,\n    selected_resource: selected_resource,\n    resource_request: resource_request,\n    message: `âœ… Mandate Ready!\\n\\nSource: ${data.was_reused ? 'Reused existing â™»ï¸' : 'Created new ğŸ†•'}\\nBudget: $${verification.budget_remaining}\\n\\nMerchant: ${merchant.name}\\nResource: ${selected_resource.title}`\n  }\n}];"},"typeVersion":2},{"id":"8d0a44b0-efe9-48ed-9e92-3c08f8741e35","name":"9ï¸âƒ£ Request Resource (x402)","type":"n8n-nodes-base.httpRequest","position":[2320,192],"parameters":{"url":"={{ $json.config.seller.api_url }}/resource/{{ $json.config.seller.selected_resource_id }}","options":{"response":{"response":{"neverError":true,"fullResponse":true}}},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"x-agent-id","value":"={{ $json.config.buyer.email }}"},{"name":"x-mandate","value":"={{ $json.mandate.token }}"}]}},"typeVersion":4.2},{"id":"187810bc-9ee3-4fdb-8577-338dd8e45d01","name":"9Bï¸âƒ£ Parse 402 Response","type":"n8n-nodes-base.code","position":[2528,192],"parameters":{"jsCode":"const response = $input.first().json;\nconst body = response.body || response;\n\nif (response.statusCode !== 402 && body.statusCode !== 402) {\n  throw new Error(`Expected 402 Payment Required, got ${response.statusCode || body.statusCode}`);\n}\n\nconst payment_required = body;\nconst data = $('8ï¸âƒ£ ğŸ”€ Merge Paths').first().json;\n\nreturn [{\n  json: {\n    ...data,\n    payment_required: payment_required,\n    message: `ğŸ’° 402 Received!\\n\\nWallet: ${payment_required.payTo}\\nAmount: $${payment_required.priceUsd}\\nToken: ${payment_required.token}\\nChain: ${payment_required.chain}`\n  }\n}];"},"typeVersion":2},{"id":"d75a575f-995e-4dca-82b3-c48e7b095257","name":"ğŸ”Ÿ ğŸ”’ Sign Payment (Render)","type":"n8n-nodes-base.httpRequest","position":[2720,192],"parameters":{"url":"={{ $('8ï¸âƒ£ ğŸ”€ Merge Paths').item.json.config.render.service_url }}/sign-payment","method":"POST","options":{},"jsonBody":"={\n  \"merchant_address\": \"{{ $json.payment_required.payTo }}\",\n  \"total_amount\": \"{{ $json.payment_required.amount }}\",\n  \"token\": \"{{ $json.payment_required.token }}\",\n  \"chain\": \"{{ $json.payment_required.chain }}\"\n}","sendBody":true,"sendHeaders":true,"specifyBody":"json","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"x-api-key","value":"={{ $('8ï¸âƒ£ ğŸ”€ Merge Paths').item.json.config.buyer.api_key }}"}]}},"typeVersion":4.2},{"id":"2eab8b07-a05e-4391-9ec1-2b5c3a1c9697","name":"1ï¸âƒ£1ï¸âƒ£ Extract TX Hashes","type":"n8n-nodes-base.code","position":[2928,192],"parameters":{"jsCode":"const render_response = $input.first().json;\nconst data = $('9Bï¸âƒ£ Parse 402 Response').first().json;\n\nif (!render_response.success) {\n  throw new Error(`Render signing failed: ${render_response.error || 'Unknown error'}`);\n}\n\nif (!render_response.tx_hash || !render_response.tx_hash_commission) {\n  throw new Error('Missing transaction hashes from Render');\n}\n\nreturn [{\n  json: {\n    ...data,\n    payment_proof: {\n      tx_hash: render_response.tx_hash,\n      tx_hash_commission: render_response.tx_hash_commission,\n      status: 'confirmed',\n      from: render_response.from,\n      merchant: data.payment_required.payTo,\n      commission_address: render_response.commission_address,\n      total_usd: render_response.total_usd,\n      merchant_usd: render_response.merchant_usd,\n      commission_usd: render_response.commission_usd,\n      token: data.payment_required.token,\n      chain: data.payment_required.chain,\n      merchant_url: `https://basescan.org/tx/${render_response.tx_hash}`,\n      commission_url: `https://basescan.org/tx/${render_response.tx_hash_commission}`\n    }\n  }\n}];"},"typeVersion":2},{"id":"1aad75be-ca5b-447a-8b5f-6907b369ecde","name":"1ï¸âƒ£2ï¸âƒ£ Submit Payment (MCP)","type":"n8n-nodes-base.httpRequest","position":[3136,192],"parameters":{"url":"={{ $json.config.agentgatepay.mcp_endpoint }}","method":"POST","options":{},"jsonBody":"={\n  \"jsonrpc\": \"2.0\",\n  \"id\": 2,\n  \"method\": \"tools/call\",\n  \"params\": {\n    \"name\": \"agentpay_submit_payment\",\n    \"arguments\": {\n      \"mandate_token\": \"{{ $json.mandate.token }}\",\n      \"tx_hash\": \"{{ $json.payment_proof.tx_hash }}\",\n      \"tx_hash_commission\": \"{{ $json.payment_proof.tx_hash_commission }}\",\n      \"chain\": \"{{ $json.payment_required.chain }}\",\n      \"token\": \"{{ $json.payment_required.token }}\",\n      \"price_usd\": \"{{ $json.payment_required.priceUsd }}\"\n    }\n  }\n}","sendBody":true,"sendHeaders":true,"specifyBody":"json","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"x-api-key","value":"={{ $('8ï¸âƒ£ ğŸ”€ Merge Paths').first().json.config.buyer.api_key }}"}]}},"typeVersion":4.2},{"id":"7a2ff1f9-bf4a-425a-ba93-125ec6c95ed3","name":"1ï¸âƒ£3ï¸âƒ£ Receive Resource","type":"n8n-nodes-base.httpRequest","position":[3344,192],"parameters":{"url":"={{ $('9Bï¸âƒ£ Parse 402 Response').first().json.config.seller.api_url }}/resource/{{ $('9Bï¸âƒ£ Parse 402 Response').first().json.config.seller.selected_resource_id }}","options":{"response":{"response":{"fullResponse":true,"responseFormat":"json"}}},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"x-payment","value":"={{ $('1ï¸âƒ£1ï¸âƒ£ Extract TX Hashes').first().json.payment_proof.tx_hash }}"}]}},"typeVersion":4.2},{"id":"cec5d7b2-90e4-4d84-81cc-cf4d6f33a308","name":"1ï¸âƒ£4ï¸âƒ£ Complete Task","type":"n8n-nodes-base.code","position":[3552,192],"parameters":{"jsCode":"const resource_http_response = $input.first().json;\nconst payment_data = $('1ï¸âƒ£1ï¸âƒ£ Extract TX Hashes').first().json;\nconst merge_data = $('8ï¸âƒ£ ğŸ”€ Merge Paths').first().json;\n\nconst resource_body = resource_http_response.body || resource_http_response;\nlet resource_data = typeof resource_body === 'object' ? resource_body : { raw: resource_body };\n\nconst spent = parseFloat(payment_data.payment_required.priceUsd);\nconst budget_before = merge_data.verification.budget_remaining;\nconst budget_after = budget_before - spent;\n\nreturn [{\n  json: {\n    config: merge_data.config,\n    session: merge_data.session,\n    resource_data: resource_data,\n    resource_http_status: resource_http_response.statusCode,\n    payment_proof: payment_data.payment_proof,\n    summary: {\n      task: merge_data.config.buyer.task,\n      status: \"COMPLETED\",\n      mandate_source: merge_data.was_reused ? \"Reused (â™»ï¸)\" : \"Created New (ğŸ†•)\",\n      mandate_storage: \"Data Tables (1 column!)\",\n      budget_before_payment: budget_before,\n      budget_spent: spent,\n      budget_remaining: budget_after,\n      merchant_tx: payment_data.payment_proof.tx_hash,\n      commission_tx: payment_data.payment_proof.tx_hash_commission,\n      completed_at: new Date().toISOString()\n    },\n    message: `ğŸ‰ TASK COMPLETED !\\n\\nâœ… Task: \"${merge_data.config.buyer.task}\"\\nâœ… Resource Received (HTTP ${resource_http_response.statusCode})\\n\\nğŸ”’ Mandate: ${merge_data.was_reused ? 'REUSED â™»ï¸' : 'CREATED NEW ğŸ†•'}\\nğŸ“Š Storage: Data Tables (just 1 column!)\\n\\nğŸ’° Budget:\\n   - Before: $${budget_before}\\n   - Spent: $${spent}\\n   - After: $${budget_after}\\n\\nğŸ”— TX: ${payment_data.payment_proof.tx_hash}\\n\\nâœ… v3.7 = ULTRA SIMPLE!\\n   - 1 column table (not 9!)\\n   - Gateway is source of truth\\n   - Clear error messages\\n   - No auto-renewal (security!)\\n   - Easy manual renewal (delete row)`\n  }\n}];"},"typeVersion":2},{"id":"77711363-6bea-4837-8ee9-aa49bbe04633","name":"START HERE","type":"n8n-nodes-base.stickyNote","position":[0,0],"parameters":{"color":4,"width":520,"height":600,"content":"# Buyer Agent Workflow\n\n**What it does:** AI agent that buys resources from sellers using AgentGatePay. Automatically reuses mandate tokens to track spending.\n\n**Quick setup (2 min):**\n1. Create Data Table called `AgentPay_Mandates` with one column: `mandate_token` (type: String).\n2. Choose blockchain: coin and network\n3. Click Node 2 and Node 7, re-select the table from dropdowns\n4. Edit Node 1 with your email, AgentGatePay API Key,seller URL, budget ($100 default) and Render URL or other external TX service for signing transactions.\n\n**How it works:**\n- First run creates a mandate token and saves it to the table\n- Next runs reuse the same token\n- Budget decreases with each payment\n- When budget's gone, delete the table row and run again for a fresh mandate\n\n**Cost:** $0.01 per resource Â· Budget tracked automatically Â· No surprises\n\nFor more info:\nhttps://github.com/AgentGatePay/agentgatepay-examples/tree/main/n8n"},"typeVersion":1},{"id":"49fe3a6c-4c97-4c7a-b5a4-764da49d2866","name":"Sticky Note 1","type":"n8n-nodes-base.stickyNote","position":[560,224],"parameters":{"color":7,"width":880,"height":280,"content":"## Mandate Management\n\nLoads your config, checks if you have an existing mandate token in the Data Table. If found, verify it. If not, create a new one."},"typeVersion":1},{"id":"3c1b7cc0-e7ab-466e-abf8-71b752011527","name":"Sticky Note 2","type":"n8n-nodes-base.stickyNote","position":[1632,64],"parameters":{"color":7,"width":418,"height":280,"content":"## Token Verification\n\nAsks AgentGatePay if your existing token is still valid. Checks signature, expiry, and remaining budget. If expired, you'll get clear instructions to renew."},"typeVersion":1},{"id":"f42cea23-beb7-4fd2-8a63-b90ed0e7adb6","name":"Sticky Note 3","type":"n8n-nodes-base.stickyNote","position":[1632,384],"parameters":{"color":7,"width":1228,"height":280,"content":"## New Mandate Creation\n\nCreates fresh mandate via Gateway API, verifies it works, validates the token format, then saves to Data Table. Only runs when you don't have a valid token."},"typeVersion":1},{"id":"368ec38d-61d3-4a32-aab6-f1fe07d7aa2e","name":"Sticky Note 4","type":"n8n-nodes-base.stickyNote","position":[2080,64],"parameters":{"color":7,"width":952,"height":280,"content":"## Payment Flow\n\nMerges both paths (reused or new token), requests the resource, receives 402 payment details, signs the payment via Render service, extracts transaction hashes."},"typeVersion":1},{"id":"d0ca8152-ff18-4414-b214-72c47dad9d19","name":"Sticky Note 5","type":"n8n-nodes-base.stickyNote","position":[3072,64],"parameters":{"color":7,"width":648,"height":280,"content":"## Resource Delivery\n\nSubmits payment proof to Gateway, receives the paid resource from seller, calculates updated budget, and completes the task with full summary."},"typeVersion":1}],"active":false,"pinData":{},"settings":{"executionOrder":"v1"},"versionId":"62f2c498-0f5e-4d72-a9b5-1ec08961a0d5","connections":{"â–¶ï¸ START":{"main":[[{"node":"1ï¸âƒ£ Load Config","type":"main","index":0}]]},"3ï¸âƒ£ Has Token?":{"main":[[{"node":"4ï¸âƒ£ âœ… Verify Existing Token","type":"main","index":0}],[{"node":"5ï¸âƒ£ ğŸ†• Create New Mandate","type":"main","index":0}]]},"1ï¸âƒ£ Load Config":{"main":[[{"node":"2ï¸âƒ£ ğŸ“Š Get Mandate Token","type":"main","index":0}]]},"7Bï¸âƒ£ Restore Data":{"main":[[{"node":"8ï¸âƒ£ ğŸ”€ Merge Paths","type":"main","index":0}]]},"8ï¸âƒ£ ğŸ”€ Merge Paths":{"main":[[{"node":"9ï¸âƒ£ Request Resource (x402)","type":"main","index":0}]]},"2Bï¸âƒ£ Normalize Result":{"main":[[{"node":"3ï¸âƒ£ Has Token?","type":"main","index":0}]]},"7ï¸âƒ£ ğŸ’¾ Insert Token":{"main":[[{"node":"7Bï¸âƒ£ Restore Data","type":"main","index":0}]]},"5Bï¸âƒ£ Parse New Mandate":{"main":[[{"node":"6ï¸âƒ£ âœ… Verify New Mandate","type":"main","index":0}]]},"6Bï¸âƒ£ Check New Mandate":{"main":[[{"node":"7ï¸âƒ£ ğŸ’¾ Insert Token","type":"main","index":0}]]},"4Bï¸âƒ£ Check Verification":{"main":[[{"node":"8ï¸âƒ£ ğŸ”€ Merge Paths","type":"main","index":0}]]},"9Bï¸âƒ£ Parse 402 Response":{"main":[[{"node":"ğŸ”Ÿ ğŸ”’ Sign Payment (Render)","type":"main","index":0}]]},"2ï¸âƒ£ ğŸ“Š Get Mandate Token":{"main":[[{"node":"2Bï¸âƒ£ Normalize Result","type":"main","index":0}]]},"6ï¸âƒ£ âœ… Verify New Mandate":{"main":[[{"node":"6Bï¸âƒ£ Check New Mandate","type":"main","index":0}]]},"1ï¸âƒ£3ï¸âƒ£ Receive Resource":{"main":[[{"node":"1ï¸âƒ£4ï¸âƒ£ Complete Task","type":"main","index":0}]]},"5ï¸âƒ£ ğŸ†• Create New Mandate":{"main":[[{"node":"5Bï¸âƒ£ Parse New Mandate","type":"main","index":0}]]},"9ï¸âƒ£ Request Resource (x402)":{"main":[[{"node":"9Bï¸âƒ£ Parse 402 Response","type":"main","index":0}]]},"ğŸ”Ÿ ğŸ”’ Sign Payment (Render)":{"main":[[{"node":"1ï¸âƒ£1ï¸âƒ£ Extract TX Hashes","type":"main","index":0}]]},"1ï¸âƒ£1ï¸âƒ£ Extract TX Hashes":{"main":[[{"node":"1ï¸âƒ£2ï¸âƒ£ Submit Payment (MCP)","type":"main","index":0}]]},"4ï¸âƒ£ âœ… Verify Existing Token":{"main":[[{"node":"4Bï¸âƒ£ Check Verification","type":"main","index":0}]]},"1ï¸âƒ£2ï¸âƒ£ Submit Payment (MCP)":{"main":[[{"node":"1ï¸âƒ£3ï¸âƒ£ Receive Resource","type":"main","index":0}]]}}}