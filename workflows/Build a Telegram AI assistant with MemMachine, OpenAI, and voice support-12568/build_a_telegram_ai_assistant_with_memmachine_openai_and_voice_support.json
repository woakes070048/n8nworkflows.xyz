{"meta":{"instanceId":"2000c64071c20843606b95c63795bb0797c41036047055a6586498e855b96efc"},"nodes":[{"id":"69c4a2d6-7ad7-40c3-98cc-dc70b07ff2d9","name":"ðŸ“Œ START HERE","type":"n8n-nodes-base.stickyNote","position":[-2384,32],"parameters":{"color":4,"width":516,"height":664,"content":"## ðŸ¤– Telegram assistant with memory\n\n**Author:** **David Olusola (@DaexAI)**\n\nAI assistant that remembers conversations across sessions using MemMachine.\n\n**Features:**\nâœ… Persistent cross-session memory\nâœ… Voice transcription (Whisper)\nâœ… Gmail, Sheets, Calendar tools\nâœ… MCP architecture\n\n## How it works\n1. Message arrives (text/voice)\n2. Store in MemMachine\n3. Retrieve conversation history\n4. AI processes with context\n5. Store response & send\n\n## Setup steps\n1. Install MemMachine: `docker-compose up -d`\n2. Update org_id/project_id (nodes 4,5,9)\n3. Add credentials (Telegram, OpenAI, Google)\n4. Test with messages"},"typeVersion":1},{"id":"cb1127b4-2523-412c-a5ea-88b517365008","name":"Voice Processing","type":"n8n-nodes-base.stickyNote","position":[-1760,448],"parameters":{"color":7,"width":540,"height":180,"content":"**Voice path:** Download â†’ Transcribe (Whisper) â†’ Extract data"},"typeVersion":1},{"id":"79fc7e0e-9336-4d4c-bf89-61371e7fe845","name":"Text Processing","type":"n8n-nodes-base.stickyNote","position":[-1296,688],"parameters":{"color":7,"height":140,"content":"**Text path:** Extract message data"},"typeVersion":1},{"id":"39310aca-d76b-4282-84c4-88bd8aef7f07","name":"MemMachine Memory","type":"n8n-nodes-base.stickyNote","position":[-1088,544],"parameters":{"color":5,"width":560,"height":200,"content":"**Memory system:** Store message â†’ Search history (30 memories) â†’ Sort chronologically"},"typeVersion":1},{"id":"5884f294-c899-4040-8b4f-5560b2297dcc","name":"AI Processing","type":"n8n-nodes-base.stickyNote","position":[-400,496],"parameters":{"color":6,"width":280,"height":388,"content":"**AI + Tools:** Process with context, access Gmail/Sheets/Calendar via MCP"},"typeVersion":1},{"id":"51b5f366-9a3c-4634-89b2-54b7a0ea8873","name":"Response Flow","type":"n8n-nodes-base.stickyNote","position":[-64,544],"parameters":{"color":3,"width":616,"height":232,"content":"**Response:** Extract â†’ Store in memory â†’ Send to Telegram"},"typeVersion":1},{"id":"9095fb71-e42e-490d-ac81-c0e1665fac27","name":"MCP Architecture","type":"n8n-nodes-base.stickyNote","position":[0,0],"parameters":{"color":2,"width":480,"height":392,"content":"**MCP Server:** Exposes Gmail, Sheets, Calendar. **MCP Client:** Connects AI to tools"},"typeVersion":1},{"id":"6db9edeb-b557-46a4-a2fe-c8638a76ee53","name":"Memory Example","type":"n8n-nodes-base.stickyNote","position":[-1824,32],"parameters":{"color":2,"width":420,"height":400,"content":"## ðŸŽ¯ Memory Example\n\n**Day 1:** \"Email john@co.com about Q1\"\n**Day 3:** \"What did I ask about John?\"\n**AI:** \"You asked me to email John about Q1 on Jan 5th\"\n\n**Day 7 (voice):** \"Follow up with John\"\n**AI:** \"I'll send follow-up to john@co.com about Q1\"\n\nAI remembers who, what, when across text & voice!"},"typeVersion":1},{"id":"aa2f7d4c-252e-4219-bd18-33764d489a0f","name":"Quick Setup","type":"n8n-nodes-base.stickyNote","position":[-1360,32],"parameters":{"color":5,"width":564,"height":480,"content":"## ðŸš€ Quick Setup\n\n**1. Install MemMachine**\n```bash\ngit clone https://github.com/MemMachine/MemMachine\ncd MemMachine\ndocker-compose up -d\n```\n\n**2. Import & Configure**\n- Import this workflow\n- Update nodes 4,5,9: org_id, project_id\n- Add credentials (Telegram, OpenAI, Google)\n\n**3. Test**\n- Text message â†’ Check response\n- Voice message â†’ Check transcription\n- Ask about past chats â†’ Check memory"},"typeVersion":1},{"id":"18ad594a-505e-4ec6-a718-6bc8790162b2","name":"Customization","type":"n8n-nodes-base.stickyNote","position":[-672,32],"parameters":{"color":6,"width":360,"height":320,"content":"## ðŸ’¡ Customization\n\n**Memory:** Increase top_k (node 5)\n**Tools:** Add Notion, Slack, Trello\n**Multi-channel:** WhatsApp, SMS, Web\n**AI:** Edit system prompt (node 7)\n**Advanced:** User preferences, automation"},"typeVersion":1},{"id":"29b7a9ee-6e91-4bf6-8237-0b8428a97281","name":"1. Telegram Trigger","type":"n8n-nodes-base.telegramTrigger","position":[-2160,624],"webhookId":"telegram-webhook-main","parameters":{"updates":["message"],"additionalFields":{}},"typeVersion":1.2},{"id":"fc33e6af-a436-4014-8bcf-6cbf537062bd","name":"2. Message Type","type":"n8n-nodes-base.switch","position":[-1936,624],"parameters":{"rules":{"values":[{"outputKey":"Voice","conditions":{"options":{"version":2},"conditions":[{"operator":{"type":"string","operation":"exists"},"leftValue":"={{ $json.message.voice.file_id }}"}]},"renameOutput":true},{"outputKey":"Text","conditions":{"options":{"version":2},"conditions":[{"operator":{"type":"string","operation":"exists"},"leftValue":"={{ $json.message.text }}"}]},"renameOutput":true}]},"options":{}},"typeVersion":3.2},{"id":"757997dc-dd82-4f4d-9791-6586c10d2c22","name":"3a. Download Voice","type":"n8n-nodes-base.telegram","position":[-1712,528],"webhookId":"voice-download-wh","parameters":{"fileId":"={{ $json.message.voice.file_id }}","resource":"file","additionalFields":{}},"typeVersion":1.2},{"id":"d83fc081-e68e-4fe6-9961-02b69e71ac76","name":"3b. Transcribe Voice","type":"@n8n/n8n-nodes-langchain.openAi","position":[-1488,528],"parameters":{"options":{},"resource":"audio","operation":"transcribe"},"typeVersion":1.6},{"id":"94cafb17-2ec2-4949-b024-5cb806477ef7","name":"3c. Extract Voice Data","type":"n8n-nodes-base.set","position":[-1264,528],"parameters":{"options":{},"assignments":{"assignments":[{"id":"a1","name":"text","type":"string","value":"={{ $json.text }}"},{"id":"a2","name":"chat_id","type":"number","value":"={{ $('1. Telegram Trigger').item.json.message.chat.id }}"},{"id":"a3","name":"user_id","type":"number","value":"={{ $('1. Telegram Trigger').item.json.message.from.id }}"},{"id":"a4","name":"username","type":"string","value":"={{ $('1. Telegram Trigger').item.json.message.from.username || $('1. Telegram Trigger').item.json.message.from.first_name }}"},{"id":"a5","name":"customer_email","type":"string","value":"={{ $('1. Telegram Trigger').item.json.message.from.id }}@telegram.user"}]}},"typeVersion":3.4},{"id":"be4a289a-cc38-40ed-93f9-ba3b9900a60d","name":"3d. Extract Text Data","type":"n8n-nodes-base.set","position":[-1264,720],"parameters":{"options":{},"assignments":{"assignments":[{"id":"a1","name":"text","type":"string","value":"={{ $json.message.text }}"},{"id":"a2","name":"chat_id","type":"number","value":"={{ $json.message.chat.id }}"},{"id":"a3","name":"user_id","type":"number","value":"={{ $json.message.from.id }}"},{"id":"a4","name":"username","type":"string","value":"={{ $json.message.from.username || $json.message.from.first_name }}"},{"id":"a5","name":"customer_email","type":"string","value":"={{ $json.message.from.id }}@telegram.user"}]}},"typeVersion":3.4},{"id":"68fd10c0-060c-455e-883e-b350785ec349","name":"4. Store User Query","type":"n8n-nodes-base.httpRequest","position":[-1040,624],"parameters":{"url":"http://host.docker.internal:8080/api/v2/memories","method":"POST","options":{},"jsonBody":"={\n  \"org_id\": \"your-org-id\",\n  \"project_id\": \"your-project-id\",\n  \"messages\": [{\n    \"content\": \"{{ $json.text }}\",\n    \"producer\": \"{{ $json.customer_email }}\",\n    \"produced_for\": \"assistant\",\n    \"role\": \"user\",\n    \"metadata\": {\n      \"customer_email\": \"{{ $json.customer_email }}\",\n      \"channel\": \"telegram\",\n      \"username\": \"{{ $json.username }}\",\n      \"user_id\": \"{{ $json.user_id }}\",\n      \"timestamp\": \"{{ $now.toISO() }}\"\n    }\n  }]\n}","sendBody":true,"sendHeaders":true,"specifyBody":"json","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"typeVersion":4.1},{"id":"fe5454d3-96fc-4252-896a-d689ce64e948","name":"5. Search Memory","type":"n8n-nodes-base.httpRequest","position":[-816,624],"parameters":{"url":"http://host.docker.internal:8080/api/v2/memories/search","method":"POST","options":{},"jsonBody":"={\n  \"org_id\": \"your-org-id\",\n  \"project_id\": \"your-project-id\",\n  \"query\": \"{{ $input.item.json.text }}\",\n  \"top_k\": 30,\n  \"filter\": \"metadata.customer_email='{{ $input.item.json.customer_email }}'\",\n  \"types\": [\"episodic\", \"semantic\"]\n}","sendBody":true,"sendHeaders":true,"specifyBody":"json","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"typeVersion":4.1},{"id":"de69ae7e-8a35-4923-ba7f-3ebe367eab6b","name":"6. Format Memory","type":"n8n-nodes-base.code","position":[-592,624],"parameters":{"jsCode":"const memoryData = $input.first().json;\nconst content = memoryData.content || memoryData;\nconst episodicMemory = content.episodic_memory || {};\nconst longTermEpisodes = episodicMemory.long_term_memory?.episodes || [];\nconst shortTermEpisodes = episodicMemory.short_term_memory?.episodes || [];\nconst allMemories = [...longTermEpisodes, ...shortTermEpisodes];\n\nconst sortedMemories = allMemories.sort((a, b) => {\n  const timeA = a.timestamp || a.created_at || a.metadata?.timestamp || '';\n  const timeB = b.timestamp || b.created_at || b.metadata?.timestamp || '';\n  return new Date(timeA).getTime() - new Date(timeB).getTime();\n});\n\nconst conversationHistory = sortedMemories\n  .filter(m => m.content && m.content.trim() !== '')\n  .slice(-20)\n  .map(memory => {\n    const role = memory.producer_role || memory.role || 'unknown';\n    return `[${role}]: ${memory.content}`;\n  }).join('\\n');\n\nconst inputData = $('4. Store User Query').first()?.json || {};\n\nreturn [{\n  json: {\n    text: inputData.text,\n    chat_id: inputData.chat_id,\n    customer_email: inputData.customer_email,\n    username: inputData.username,\n    conversation_history: conversationHistory || 'No previous history.',\n    total_memories: allMemories.length\n  }\n}];"},"typeVersion":2},{"id":"26634a9b-b148-4dec-a7e8-5c4c0fc5299e","name":"7. AI Agent","type":"@n8n/n8n-nodes-langchain.agent","position":[-368,624],"parameters":{"text":"={{ $json.text }}","options":{"systemMessage":"=# Personal Assistant\n\nUser: {{ $json.username }} ({{ $json.customer_email }})\n\n## Conversation History\n{{ $json.conversation_history }}\n\n## Tools\n- Gmail: Send/read emails\n- Google Sheets: Read/write data\n- Google Calendar: Manage events\n\n## Instructions\n- Reference past conversations naturally\n- Use tools proactively\n- Be concise and helpful\n- Confirm before important actions\n\nCurrent date: {{ $now }}\nMemories: {{ $json.total_memories }}"},"promptType":"define"},"typeVersion":1.7},{"id":"8dd7e9e7-a9ec-42e0-a260-0926da3eb041","name":"8. Extract Response","type":"n8n-nodes-base.set","position":[-16,624],"parameters":{"options":{},"assignments":{"assignments":[{"id":"a1","name":"ai_response","type":"string","value":"={{ $json.output }}"},{"id":"a2","name":"customer_email","type":"string","value":"={{ $('6. Format Memory').item.json.customer_email }}"},{"id":"a3","name":"username","type":"string","value":"={{ $('6. Format Memory').item.json.username }}"},{"id":"a4","name":"chat_id","type":"number","value":"={{ $('6. Format Memory').item.json.chat_id }}"}]}},"typeVersion":3.4},{"id":"44b3e123-288f-44bc-aac6-f4c2323973f0","name":"9. Store AI Response","type":"n8n-nodes-base.httpRequest","position":[208,624],"parameters":{"url":"http://host.docker.internal:8080/api/v2/memories","method":"POST","options":{},"jsonBody":"={\n  \"org_id\": \"your-org-id\",\n  \"project_id\": \"your-project-id\",\n  \"messages\": [{\n    \"content\": \"{{ $json.ai_response }}\",\n    \"producer\": \"assistant\",\n    \"produced_for\": \"{{ $json.customer_email }}\",\n    \"role\": \"assistant\",\n    \"metadata\": {\n      \"customer_email\": \"{{ $json.customer_email }}\",\n      \"channel\": \"telegram\",\n      \"username\": \"{{ $json.username }}\",\n      \"timestamp\": \"{{ $now.toISO() }}\"\n    }\n  }]\n}","sendBody":true,"sendHeaders":true,"specifyBody":"json","headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]}},"typeVersion":4.1},{"id":"1192ae4d-fda6-46c2-9bef-770d029b7195","name":"10. Send Response","type":"n8n-nodes-base.telegram","position":[432,624],"webhookId":"response-webhook-main","parameters":{"text":"={{ $json.ai_response }}","chatId":"={{ $json.chat_id }}","additionalFields":{"parse_mode":"Markdown","appendAttribution":false}},"typeVersion":1.2},{"id":"9e47a6f7-408d-4b1d-b324-1a29ef815a4f","name":"MCP Server Trigger","type":"@n8n/n8n-nodes-langchain.mcpTrigger","position":[144,48],"webhookId":"298e8ee6-95f2-408b-97df-af61f48a20ec","parameters":{"path":"298e8ee6-95f2-408b-97df-af61f48a20ec"},"typeVersion":2},{"id":"9ba03bb9-d648-4d42-88d0-1ef0484ff0a2","name":"Gmail Tool","type":"n8n-nodes-base.gmailTool","position":[80,256],"webhookId":"b80af49a-032b-4fb1-8201-a93f65d5e1dc","parameters":{"sendTo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('To', ``, 'string') }}","message":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message', ``, 'string') }}","options":{},"subject":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Subject', ``, 'string') }}"},"typeVersion":2.2},{"id":"9eee6483-07d0-4fb9-b1a8-11ffe7c0c2cc","name":"Google Sheets Tool","type":"n8n-nodes-base.googleSheetsTool","position":[208,256],"parameters":{"options":{},"sheetName":{"__rl":true,"mode":"id","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Sheet', ``, 'string') }}"},"documentId":{"__rl":true,"mode":"id","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Document', ``, 'string') }}"}},"typeVersion":4.7},{"id":"a94cbd68-6365-45bf-acea-5d06cd986f9a","name":"Google Calendar Tool","type":"n8n-nodes-base.googleCalendarTool","position":[336,240],"parameters":{"calendar":{"__rl":true,"mode":"id","value":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Calendar', ``, 'string') }}","__regex":"(^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\\.[a-zA-Z0-9-]+)*)"},"additionalFields":{}},"typeVersion":1.3},{"id":"138af0c0-29e1-49bc-87ca-578838a0cf9d","name":"MCP Client","type":"@n8n/n8n-nodes-langchain.mcpClientTool","position":[-224,800],"parameters":{"options":{}},"typeVersion":1.2},{"id":"a00883e5-6e68-4891-9035-8a01299abfe0","name":"OpenAI Chat Model","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[-352,800],"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o-mini"},"options":{},"builtInTools":{}},"typeVersion":1.3}],"pinData":{},"connections":{"Gmail Tool":{"ai_tool":[[{"node":"MCP Server Trigger","type":"ai_tool","index":0}]]},"MCP Client":{"ai_tool":[[{"node":"7. AI Agent","type":"ai_tool","index":0}]]},"7. AI Agent":{"main":[[{"node":"8. Extract Response","type":"main","index":0}]]},"2. Message Type":{"main":[[{"node":"3a. Download Voice","type":"main","index":0}],[{"node":"3d. Extract Text Data","type":"main","index":0}]]},"5. Search Memory":{"main":[[{"node":"6. Format Memory","type":"main","index":0}]]},"6. Format Memory":{"main":[[{"node":"7. AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"7. AI Agent","type":"ai_languageModel","index":0}]]},"3a. Download Voice":{"main":[[{"node":"3b. Transcribe Voice","type":"main","index":0}]]},"Google Sheets Tool":{"ai_tool":[[{"node":"MCP Server Trigger","type":"ai_tool","index":0}]]},"1. Telegram Trigger":{"main":[[{"node":"2. Message Type","type":"main","index":0}]]},"4. Store User Query":{"main":[[{"node":"5. Search Memory","type":"main","index":0}]]},"8. Extract Response":{"main":[[{"node":"9. Store AI Response","type":"main","index":0}]]},"3b. Transcribe Voice":{"main":[[{"node":"3c. Extract Voice Data","type":"main","index":0}]]},"9. Store AI Response":{"main":[[{"node":"10. Send Response","type":"main","index":0}]]},"Google Calendar Tool":{"ai_tool":[[{"node":"MCP Server Trigger","type":"ai_tool","index":0}]]},"3d. Extract Text Data":{"main":[[{"node":"4. Store User Query","type":"main","index":0}]]},"3c. Extract Voice Data":{"main":[[{"node":"4. Store User Query","type":"main","index":0}]]}}}