MongoDB AI Agent - Intelligent Movie Recommendations

https://n8nworkflows.xyz/workflows/mongodb-ai-agent---intelligent-movie-recommendations-2554


# MongoDB AI Agent - Intelligent Movie Recommendations

### 1. Workflow Overview

This workflow implements an **Intelligent Movie Recommendation Agent** that leverages MongoDB, OpenAI, and LangChain capabilities to enable natural language interaction with a movie database. It targets database administrators, developers, and content managers aiming to simplify querying, enhance user engagement, and maintain conversational context.

The workflow is logically grouped into the following blocks:

- **1.1 Input Reception**: Receives user chat messages via a webhook trigger.
- **1.2 AI Agent Processing**: Uses OpenAI Chat Model and LangChain to interpret user queries, maintain conversation context, and decide on actions.
- **1.3 MongoDB Interaction**: Translates natural language queries into MongoDB aggregation pipelines and retrieves data.
- **1.4 Favorites Management**: Allows users to save favorite movies into the MongoDB collection.
- **1.5 Context Memory**: Keeps a windowed conversational memory for multi-turn dialogue continuity.
- **1.6 Notes and Documentation**: Provides embedded sticky notes describing workflow purpose and process.

---

### 2. Block-by-Block Analysis

#### 2.1 Input Reception

- **Overview**: Captures incoming chat messages from users through a public webhook to initiate the workflow.
- **Nodes Involved**:  
  - When chat message received
- **Node Details**:

  - **When chat message received**  
    - Type: `chatTrigger` (LangChain integration)  
    - Role: Public webhook to receive chat messages from any origin (CORS allowed: "*")  
    - Configuration: `mode` set to "webhook", `public` true, webhook ID assigned  
    - Inputs: External HTTP requests with chat message payload  
    - Outputs: Triggers downstream AI Agent node  
    - Edge Cases: Webhook misconfiguration could block message reception; CORS misconfiguration could restrict clients; payload format errors may cause failures.

#### 2.2 AI Agent Processing

- **Overview**: The core AI agent interprets the user's natural language input, decides which tools to invoke (MongoDB querying or favorites insertion), and generates appropriate responses.
- **Nodes Involved**:  
  - AI Agent - Movie Recommendation  
  - OpenAI Chat Model  
  - Window Buffer Memory
- **Node Details**:

  - **AI Agent - Movie Recommendation**  
    - Type: `agent` (LangChain agent node)  
    - Role: Orchestrates chat dialogue, selects tools dynamically, processes user input  
    - Configuration:  
      - Prompt defines assistant role with access to tools "MongoDBAggregate" and "insertFavorite"  
      - Expects user input in `{{ $json.chatInput }}`  
      - Conditional logic: only inserts favorites when user confirms  
    - Inputs: User chat message from webhook, memory buffer data, language model responses  
    - Outputs: Calls tools as needed, returns final chat output  
    - Edge Cases: Failures in tool invocation; ambiguity in user intent; API rate limits; prompt misconfiguration can reduce relevance.

  - **OpenAI Chat Model**  
    - Type: `lmChatOpenAi`  
    - Role: Provides natural language understanding and text generation via OpenAI API  
    - Configuration: Uses linked OpenAI credentials; no special parameters overridden  
    - Inputs: Prompts from AI Agent  
    - Outputs: Text completions to AI Agent  
    - Edge Cases: API key invalidation, quota exhaustion, network timeouts.

  - **Window Buffer Memory**  
    - Type: `memoryBufferWindow`  
    - Role: Stores last 10 conversational messages for context retention  
    - Configuration: `contextWindowLength` set to 10 messages  
    - Inputs: Conversation messages from AI Agent and user  
    - Outputs: Context passed back to AI Agent  
    - Edge Cases: Memory overflow, loss of context if window size too small, data corruption.

#### 2.3 MongoDB Interaction

- **Overview**: Converts AI-generated MongoDB aggregation pipelines from natural language to executable queries and fetches movie data accordingly.
- **Nodes Involved**:  
  - MongoDBAggregate
- **Node Details**:

  - **MongoDBAggregate**  
    - Type: `mongoDbTool`  
    - Role: Executes MongoDB aggregation pipelines generated by AI on the "movies" collection  
    - Configuration:  
      - Operation: aggregate  
      - Collection: "movies"  
      - Query: Uses `$fromAI()` expression to receive pipeline code from AI with default fallback `[{ "$match": { "rating": 5 } }]`  
      - Tool Description: Provides detailed document schema to AI to inform pipeline generation  
    - Inputs: Pipeline query from AI Agent  
    - Outputs: Aggregation results to AI Agent  
    - Credentials: MongoDB connection configured with appropriate read/write permissions  
    - Edge Cases: Malformed aggregation pipeline causing query errors; connection failures; insufficient permissions; schema mismatches.

#### 2.4 Favorites Management

- **Overview**: Inserts user-confirmed favorite movies into the MongoDB database via a dedicated sub-workflow.
- **Nodes Involved**:  
  - insertFavorite (toolWorkflow)
- **Node Details**:

  - **insertFavorite**  
    - Type: `toolWorkflow` (invokes sub-workflow)  
    - Role: Inserts favorite movie documents into MongoDB "movies" collection  
    - Configuration:  
      - Invokes sub-workflow "insertFavorites" (workflowId: `6QuKnOrpusQVu66Q`)  
      - Expects input with structure `{ "title": "<TITLE>" }`  
      - Used only when user confirms favorites in chat  
    - Inputs: Triggered by AI agent tool call  
    - Outputs: Confirmation of insertion back to AI Agent  
    - Edge Cases: Sub-workflow failure, invalid input data, MongoDB insert permissions, duplicate entries.

#### 2.5 Context Memory

- **Overview**: Maintains conversation history to preserve multi-turn dialogue coherence.
- **Nodes Involved**:  
  - Window Buffer Memory (already detailed in 2.2)  
- **Node Details**: See section 2.2.

#### 2.6 Notes and Documentation

- **Overview**: Provides embedded documentation and explanations within the workflow for maintainers and users.
- **Nodes Involved**:  
  - Sticky Note  
  - Sticky Note1
- **Node Details**:

  - **Sticky Note**  
    - Type: `stickyNote`  
    - Content: Describes AI Agent powered by OpenAI and MongoDB, explains core functionality and data flow  
    - Position: near input and AI agent nodes for context

  - **Sticky Note1**  
    - Type: `stickyNote`  
    - Content: Describes processing step: Chat Model processes message and selects appropriate tool  
    - Positioned near OpenAI Chat Model node

---

### 3. Summary Table

| Node Name                 | Node Type                        | Functional Role                          | Input Node(s)              | Output Node(s)                       | Sticky Note                                                                                                            |
|---------------------------|---------------------------------|----------------------------------------|----------------------------|------------------------------------|-----------------------------------------------------------------------------------------------------------------------|
| When chat message received | chatTrigger (LangChain)          | Receives user chat messages via webhook | External HTTP Request       | AI Agent - Movie Recommendation    |                                                                                                                       |
| AI Agent - Movie Recommendation | agent (LangChain)            | Core AI logic, decides tool usage, processes queries | When chat message received, OpenAI Chat Model, Window Buffer Memory | MongoDBAggregate, insertFavorite          |                                                                                                                       |
| OpenAI Chat Model          | lmChatOpenAi                    | Provides natural language understanding and generation | AI Agent - Movie Recommendation | AI Agent - Movie Recommendation    | ## Process: The message is being processed by the "Chat Model" and the correct tool is used according to the message. |
| Window Buffer Memory       | memoryBufferWindow              | Maintains conversational context history | AI Agent - Movie Recommendation | AI Agent - Movie Recommendation    |                                                                                                                       |
| MongoDBAggregate           | mongoDbTool                    | Executes AI-generated MongoDB aggregation pipeline | AI Agent - Movie Recommendation | AI Agent - Movie Recommendation    |                                                                                                                       |
| insertFavorite             | toolWorkflow                   | Inserts favorite movies into MongoDB via sub-workflow | AI Agent - Movie Recommendation | AI Agent - Movie Recommendation    | =Use this tool only to add favorites with the structure of {"title" : "recieved title"}                               |
| Sticky Note                | stickyNote                     | Documentation and explanation          | -                          | -                                  | ## AI Agent powered by OpenAI and MongoDB...                                                                           |
| Sticky Note1               | stickyNote                     | Documentation and explanation          | -                          | -                                  | ## Process: The message is being processed by the "Chat Model" and the correct tool is used...                         |

---

### 4. Reproducing the Workflow from Scratch

1. **Create the Webhook Trigger Node**  
   - Add node: `When chat message received` (LangChain chatTrigger)  
   - Set `mode` to `"webhook"`  
   - Set `public` to `true`  
   - Allow all origins (`allowedOrigins: "*"`).  
   - Save webhook URL for external clients.

2. **Add the AI Agent Node**  
   - Add node: `AI Agent - Movie Recommendation` (LangChain agent)  
   - Configure prompt to:  
     - Act as an assistant for movie recommendations.  
     - Accept user input from `{{ $json.chatInput }}`.  
     - Have access to two tools:  
       - `"MongoDBAggregate"`: for querying movies with aggregation pipelines.  
       - `"insertFavorite"`: for inserting favorite movies with payload `{ "title": "<TITLE>" }`.  
     - Only use `"insertFavorite"` when user confirms a favorite movie.  
   - No additional options required.

3. **Configure OpenAI Chat Model Node**  
   - Add node: `OpenAI Chat Model` (lmChatOpenAi)  
   - Set credentials to your OpenAI API key.  
   - Use default parameters.

4. **Set Up Conversation Memory Node**  
   - Add node: `Window Buffer Memory` (memoryBufferWindow)  
   - Set `contextWindowLength` to `10`.

5. **Add MongoDB Aggregate Node**  
   - Add node: `MongoDBAggregate` (mongoDbTool)  
   - Set `operation` to `aggregate`  
   - Set `collection` to `"movies"`  
   - Set `query` to expression:  
     ```js
     {{$fromAI("pipeline", "The MongoDB pipeline to execute" , "string" , [{"$match" : { "rating" : 5 }}])}}
     ```  
   - Provide detailed document structure in `toolDescription` to assist pipeline generation (include all relevant fields: plot, genres, cast, poster, title, fullplot, languages, released date, directors, rated, awards, lastupdated, year, imdb rating).  
   - Set MongoDB credentials with read/write permissions on "movies" collection.

6. **Create the Insert Favorite Sub-Workflow**  
   - Create a separate workflow called `"insertFavorites"`.  
   - This workflow should accept input in the form `{ "title": "<TITLE>" }`.  
   - It inserts a document with the given title into the "movies" collection in MongoDB.  
   - Configure MongoDB credentials accordingly.  
   - Save and note the workflow ID.

7. **Add InsertFavorite ToolWorkflow Node**  
   - Add node: `insertFavorite` (toolWorkflow)  
   - Set `name` to `"insertFavorites"`  
   - Link `workflowId` to the ID of the `"insertFavorites"` workflow created above.  
   - Add description: `"Use this tool only to add favorites with the structure of {\"title\" : \"received title\" }"`.

8. **Connect Nodes**  
   - Connect `When chat message received` main output to `AI Agent - Movie Recommendation` input.  
   - Connect `AI Agent - Movie Recommendation` outputs:  
     - `ai_languageModel` to `OpenAI Chat Model` input.  
     - `ai_memory` to `Window Buffer Memory` input.  
     - `ai_tool` to both `MongoDBAggregate` and `insertFavorite` inputs as appropriate.

9. **Add Sticky Notes for Documentation** (optional but recommended)  
   - Add sticky note near input and AI Agent nodes with content describing the AI agentâ€™s purpose and MongoDB integration.  
   - Add sticky note near OpenAI Chat Model node describing the message processing flow.

10. **Test the Workflow**  
    - Deploy and expose the webhook endpoint.  
    - Test with sample chat messages about movies.  
    - Verify MongoDB queries execute correctly and favorites insertions succeed.  
    - Adjust prompt or pipeline templates as needed.

---

### 5. General Notes & Resources

| Note Content                                                                                               | Context or Link                                                                                          |
|------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------|
| This workflow is designed as an AI autonomous agent integrating OpenAI and MongoDB aggregation pipelines. | Workflow description embedded in Sticky Note.                                                           |
| The MongoDB collection "movies" must have the specified document structure for accurate aggregation queries.| See toolDescription in MongoDBAggregate node for full schema details.                                    |
| Use the OpenAI API key with sufficient quota and permissions.                                              | Credential setup required in OpenAI Chat Model node.                                                     |
| The workflow supports adding favorite movies only when explicitly confirmed by the user.                   | Handled via conditional logic in AI Agent node and insertFavorite sub-workflow.                          |
| The window buffer memory size can be adjusted to balance context depth and performance.                    | Currently set to 10 messages in Window Buffer Memory node.                                               |
| Workflow can be extended to other domains requiring natural language to database query translation.        | Customization instructions are provided in the initial description.                                      |
| MongoDB aggregation pipeline templates can be complex; ensure AI prompt matches your schema accurately.   | Modify `toolDescription` and default pipeline in MongoDBAggregate node accordingly.                      |

---

This document provides a comprehensive and clear reference for understanding, reproducing, and modifying the "MongoDB AI Agent - Intelligent Movie Recommendations" workflow. It covers all nodes, their roles, configurations, connections, and integration points, ensuring maintainers and developers can operate and extend the workflow confidently.