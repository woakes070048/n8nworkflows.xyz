{"meta":{"templateCredsSetupCompleted":false},"name":"Invoice Processing with Validation","tags":[],"nodes":[{"id":"sticky-main","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","position":[60,60],"parameters":{"color":5,"width":340,"height":480,"content":"ðŸ§¾ Invoice Validation from Gmail\n\n### How it works\n1. Gmail trigger watches for emails with PDF attachments\n2. PDF Vector extracts vendor, amounts, line items, dates\n3. Code node validates math (qty Ã— price = amount, line items = subtotal, subtotal + tax = total)\n4. Valid invoices logged to Sheets + Slack confirmation\n5. Invalid invoices flagged separately + Slack error alert\n\n### Setup steps\n1. Connect Gmail OAuth2 credentials\n2. Add PDF Vector API key from pdfvector.com/api-keys\n3. Create Google Sheet with tabs: \"Invoices\" and \"Flagged Invoices\"\n4. Connect Slack and set notification channels\n\n### Customization\n- Adjust Â±$0.01 tolerance in Validate node\n- Add more required field checks\n- Swap Slack for email or Teams"},"typeVersion":1},{"id":"sticky-section1","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","position":[440,180],"parameters":{"width":340,"height":100,"content":"## 1. Get invoice\nDownloads PDF attachment from incoming emails"},"typeVersion":1},{"id":"sticky-section2","name":"Sticky Note2","type":"n8n-nodes-base.stickyNote","position":[840,180],"parameters":{"width":380,"height":100,"content":"## 2. Extract & validate\nAI reads invoice, then checks all calculations"},"typeVersion":1},{"id":"sticky-section3","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","position":[1280,180],"parameters":{"width":420,"height":100,"content":"## 3. Route & notify\nValid â†’ log + confirm. Invalid â†’ flag + alert."},"typeVersion":1},{"id":"gmail-trigger","name":"Gmail Trigger","type":"n8n-nodes-base.gmailTrigger","position":[460,320],"parameters":{"filters":{"includeSpamTrash":false},"pollTimes":{"item":[{"mode":"everyMinute"}]}},"credentials":{"gmailOAuth2":{"id":"YOUR_GMAIL_CREDENTIAL_ID","name":"Gmail Account"}},"typeVersion":1},{"id":"gmail-get","name":"Get attachment","type":"n8n-nodes-base.gmail","position":[660,320],"parameters":{"simple":false,"options":{"downloadAttachments":true,"dataPropertyAttachmentsPrefixName":"attachment_"},"messageId":"={{ $json.id }}","operation":"get"},"credentials":{"gmailOAuth2":{"id":"YOUR_GMAIL_CREDENTIAL_ID","name":"Gmail Account"}},"typeVersion":2.1},{"id":"code-rename","name":"Rename binary","type":"n8n-nodes-base.code","position":[860,320],"parameters":{"mode":"runOnceForAllItems","jsCode":"// Rename attachment_0 to data for PDF Vector compatibility\nconst items = $input.all();\n\nfor (const item of items) {\n  if (item.binary && item.binary.attachment_0) {\n    item.binary.data = item.binary.attachment_0;\n    delete item.binary.attachment_0;\n  }\n}\n\nreturn items;"},"typeVersion":2},{"id":"pdfvector-extract","name":"PDF Vector - Extract invoice","type":"n8n-nodes-pdfvector.pdfVector","position":[1060,320],"parameters":{"prompt":"Extract all invoice details from this document including invoice number, date, vendor information, line items with descriptions and amounts, subtotal, tax, and total amount.","schema":"{\"type\":\"object\",\"properties\":{\"invoice_number\":{\"type\":\"string\"},\"invoice_date\":{\"type\":\"string\"},\"due_date\":{\"type\":\"string\"},\"vendor_name\":{\"type\":\"string\"},\"vendor_address\":{\"type\":\"string\"},\"payment_terms\":{\"type\":\"string\"},\"line_items\":{\"type\":\"array\",\"items\":{\"type\":\"object\",\"properties\":{\"description\":{\"type\":\"string\"},\"quantity\":{\"type\":\"number\"},\"unit_price\":{\"type\":\"number\"},\"amount\":{\"type\":\"number\"}}}},\"subtotal\":{\"type\":\"number\"},\"tax_amount\":{\"type\":\"number\"},\"total_amount\":{\"type\":\"number\"},\"bank_details\":{\"type\":\"string\"}},\"required\":[\"invoice_number\",\"vendor_name\",\"total_amount\"],\"additionalProperties\":false}","resource":"document","inputType":"file","operation":"extract","binaryPropertyName":"data"},"credentials":{"pdfVectorApi":{"id":"YOUR_PDFVECTOR_CREDENTIAL_ID","name":"PDF Vector API"}},"typeVersion":1},{"id":"validate-invoice","name":"Validate invoice","type":"n8n-nodes-base.code","position":[1260,320],"parameters":{"mode":"runOnceForAllItems","jsCode":"const invoice = $input.first().json.data;\nlet validation_errors = [];\nlet calculated_subtotal = 0;\n\nif (invoice.line_items && invoice.line_items.length > 0) {\n  invoice.line_items.forEach((item, index) => {\n    if (item.quantity && item.unit_price && item.amount) {\n      const expectedAmount = item.quantity * item.unit_price;\n      if (Math.abs(expectedAmount - item.amount) > 0.01) {\n        validation_errors.push({\n          type: 'line_item_math_error',\n          message: `Line ${index + 1}: ${item.quantity} Ã— $${item.unit_price} should = $${expectedAmount.toFixed(2)}, but shows $${item.amount.toFixed(2)}`\n        });\n      }\n    }\n    calculated_subtotal += (item.amount || 0);\n  });\n} else {\n  validation_errors.push({ type: 'missing_line_items', message: 'No line items found' });\n}\n\nconst stated_subtotal = invoice.subtotal || 0;\nif (stated_subtotal > 0 && Math.abs(calculated_subtotal - stated_subtotal) > 0.01) {\n  validation_errors.push({\n    type: 'subtotal_mismatch',\n    message: `Subtotal mismatch: Line items = $${calculated_subtotal.toFixed(2)}, stated = $${stated_subtotal.toFixed(2)}`\n  });\n}\n\nconst tax = invoice.tax_amount || 0;\nconst total = invoice.total_amount || 0;\nconst subtotal_for_calc = stated_subtotal > 0 ? stated_subtotal : calculated_subtotal;\nconst expected_total = subtotal_for_calc + tax;\n\nif (total > 0 && Math.abs(expected_total - total) > 0.01) {\n  validation_errors.push({\n    type: 'total_mismatch',\n    message: `Total mismatch: $${subtotal_for_calc.toFixed(2)} + $${tax.toFixed(2)} tax should = $${expected_total.toFixed(2)}, but shows $${total.toFixed(2)}`\n  });\n}\n\nif (!invoice.invoice_number) validation_errors.push({ type: 'missing_field', message: 'Missing invoice number' });\nif (!invoice.vendor_name) validation_errors.push({ type: 'missing_field', message: 'Missing vendor name' });\nif (!invoice.total_amount) validation_errors.push({ type: 'missing_field', message: 'Missing total amount' });\n\nconst items_summary = invoice.line_items && invoice.line_items.length > 0\n  ? invoice.line_items.map(item => `${item.description}: ${item.quantity || 1} x $${item.unit_price || item.amount}`).join('; ')\n  : 'No items listed';\n\nconst is_valid = validation_errors.length === 0;\n\nreturn [{\n  json: {\n    validation_status: is_valid ? 'valid' : 'needs_review',\n    is_valid: is_valid,\n    validation_errors: validation_errors,\n    error_count: validation_errors.length,\n    invoice_data: invoice,\n    items_summary: items_summary,\n    processed_at: new Date().toISOString(),\n    email_subject: $('Gmail Trigger').first().json.subject || 'Unknown'\n  }\n}];"},"typeVersion":2},{"id":"if-valid","name":"Valid?","type":"n8n-nodes-base.if","position":[1460,320],"parameters":{"options":{},"conditions":{"options":{"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"valid-check","operator":{"type":"boolean","operation":"equals"},"leftValue":"={{ $json.is_valid }}","rightValue":true}]}},"typeVersion":2},{"id":"sheets-valid","name":"Log valid","type":"n8n-nodes-base.googleSheets","position":[1660,220],"parameters":{"columns":{"value":{"Tax":"={{ $json.invoice_data.tax_amount || 0 }}","Date":"={{ $json.invoice_data.invoice_date }}","Items":"={{ $json.items_summary }}","Total":"={{ $json.invoice_data.total_amount }}","Status":"Valid","Vendor":"={{ $json.invoice_data.vendor_name }}","Due Date":"={{ $json.invoice_data.due_date || 'N/A' }}","Subtotal":"={{ $json.invoice_data.subtotal || 0 }}","Processed":"={{ $json.processed_at.split('T')[0] }}","Invoice Number":"={{ $json.invoice_data.invoice_number }}"},"mappingMode":"defineBelow"},"operation":"append","sheetName":{"__rl":true,"mode":"list","value":"Invoices"},"documentId":{"__rl":true,"mode":"list","value":"YOUR_SPREADSHEET_ID"}},"credentials":{"googleSheetsOAuth2Api":{"id":"YOUR_SHEETS_CREDENTIAL_ID","name":"Google Sheets Account"}},"typeVersion":4.5},{"id":"sheets-flagged","name":"Log flagged","type":"n8n-nodes-base.googleSheets","position":[1660,420],"parameters":{"columns":{"value":{"Total":"={{ $json.invoice_data.total_amount }}","Errors":"={{ $json.validation_errors.map(e => e.message).join('; ') }}","Vendor":"={{ $json.invoice_data.vendor_name }}","Processed":"={{ $json.processed_at.split('T')[0] }}","Error Count":"={{ $json.error_count }}","Email Subject":"={{ $json.email_subject }}","Invoice Number":"={{ $json.invoice_data.invoice_number }}"},"mappingMode":"defineBelow"},"operation":"append","sheetName":{"__rl":true,"mode":"list","value":"Flagged Invoices"},"documentId":{"__rl":true,"mode":"list","value":"YOUR_SPREADSHEET_ID"}},"credentials":{"googleSheetsOAuth2Api":{"id":"YOUR_SHEETS_CREDENTIAL_ID","name":"Google Sheets Account"}},"typeVersion":4.5},{"id":"slack-success","name":"Slack success","type":"n8n-nodes-base.slack","position":[1860,220],"parameters":{"text":"=âœ… *Invoice Processed*\n\n*Vendor:* {{ $('Valid?').item.json.invoice_data.vendor_name }}\n*Invoice #:* {{ $('Valid?').item.json.invoice_data.invoice_number }}\n*Total:* ${{ $('Valid?').item.json.invoice_data.total_amount }}","select":"channel","channelId":{"__rl":true,"mode":"list","value":"YOUR_SLACK_CHANNEL_ID"},"otherOptions":{},"authentication":"oAuth2"},"credentials":{"slackOAuth2Api":{"id":"YOUR_SLACK_CREDENTIAL_ID","name":"Slack Account"}},"typeVersion":2.1},{"id":"slack-error","name":"Slack alert","type":"n8n-nodes-base.slack","position":[1860,420],"parameters":{"text":"=âš ï¸ *Invoice Needs Review*\n\n*Vendor:* {{ $('Valid?').item.json.invoice_data.vendor_name }}\n*Invoice #:* {{ $('Valid?').item.json.invoice_data.invoice_number }}\n*Errors:* {{ $('Valid?').item.json.validation_errors.map(e => e.message).join(', ') }}","select":"channel","channelId":{"__rl":true,"mode":"list","value":"YOUR_SLACK_CHANNEL_ID"},"otherOptions":{},"authentication":"oAuth2"},"credentials":{"slackOAuth2Api":{"id":"YOUR_SLACK_CREDENTIAL_ID","name":"Slack Account"}},"typeVersion":2.1}],"pinData":{},"settings":{"executionOrder":"v1"},"staticData":null,"connections":{"Valid?":{"main":[[{"node":"Log valid","type":"main","index":0}],[{"node":"Log flagged","type":"main","index":0}]]},"Log valid":{"main":[[{"node":"Slack success","type":"main","index":0}]]},"Log flagged":{"main":[[{"node":"Slack alert","type":"main","index":0}]]},"Gmail Trigger":{"main":[[{"node":"Get attachment","type":"main","index":0}]]},"Rename binary":{"main":[[{"node":"PDF Vector - Extract invoice","type":"main","index":0}]]},"Get attachment":{"main":[[{"node":"Rename binary","type":"main","index":0}]]},"Validate invoice":{"main":[[{"node":"Valid?","type":"main","index":0}]]},"PDF Vector - Extract invoice":{"main":[[{"node":"Validate invoice","type":"main","index":0}]]}}}