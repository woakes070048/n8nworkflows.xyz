Qualify and route consulting leads with GPT‑4.1-mini, Slack and Google Sheets

https://n8nworkflows.xyz/workflows/qualify-and-route-consulting-leads-with-gpt-4-1-mini--slack-and-google-sheets-12761


# Qualify and route consulting leads with GPT‑4.1-mini, Slack and Google Sheets

## 1. Workflow Overview

**Purpose:**  
This workflow receives consulting lead submissions via a webhook-based intake form, normalizes the data, uses an OpenAI (GPT‑4.1-mini via n8n LangChain nodes) agent to **classify and qualify** the lead, then **routes notifications** to the right Slack channel, **logs qualified leads** to Google Sheets, **sends an acknowledgment email** via Gmail, and escalates **high-urgency** leads to executives on Slack.

**Target use cases:**
- Professional services / consulting firms triaging inbound inquiries
- Automated lead qualification and service-line routing (Consulting / Accounting / Fractional CFO)
- Simple CRM-lite logging to Google Sheets plus immediate team alerts

### 1.1 Logical Blocks
1. **Intake & Baseline Configuration** (Webhook → initial Set)
2. **Data Normalization** (Set)
3. **AI Qualification & Structured Classification** (OpenAI LM + Structured Output Parser + Agent)
4. **Quality Gate & Service Routing** (IF → Switch → Slack)
5. **Lead Logging & Client Acknowledgment** (Google Sheets → OpenAI LM + Agent → Gmail)
6. **Urgency Escalation** (IF → Executive Slack alert)

---

## 2. Block-by-Block Analysis

### Block 1 — Intake & Baseline Configuration
**Overview:** Receives inbound lead data via webhook and prepares workflow-level configuration variables (intended to centralize constants like sheet IDs, Slack channels, or scoring thresholds).

**Nodes involved:**
- **Client Intake Form**
- **Workflow Configuration**

#### Node: Client Intake Form
- **Type / role:** `Webhook` (n8n-nodes-base.webhook) — workflow entry point for lead submissions.
- **Configuration (interpreted):**
  - Webhook node exists but **parameters are empty** in the provided JSON. In practice, you must configure:
    - HTTP method (typically `POST`)
    - Response mode (e.g., “On Received” or “Last Node”)
    - Path (auto-generated by n8n; node has a `webhookId`)
- **Key expressions / variables:** Not specified.
- **Connections:**
  - **Output →** Workflow Configuration
- **Failure/edge cases:**
  - Incorrect method/content-type from form (e.g., form sends `application/x-www-form-urlencoded` vs JSON)
  - Missing expected fields causing later expressions/AI prompts to degrade
  - Large payloads/timeouts if response mode waits for downstream nodes
- **Version:** typeVersion **2.1**

#### Node: Workflow Configuration
- **Type / role:** `Set` — intended to define constants and/or map webhook fields into standard names.
- **Configuration (interpreted):**
  - Parameters are empty, so currently it does not set fields.
  - Recommended usage: set items such as:
    - `companyName`, `defaultReplyFrom`, `sheetId`, `sheetTab`, `slackChannelMap`, qualification thresholds, etc.
- **Connections:**
  - **Input ←** Client Intake Form
  - **Output →** Normalize Intake Data
- **Failure/edge cases:**
  - If later nodes expect fields created here, the workflow will fail (undefined fields)
- **Version:** typeVersion **3.4**

---

### Block 2 — Data Normalization
**Overview:** Standardizes incoming lead fields into a predictable schema (e.g., name/email/company/serviceRequested/message/budget/timeline), reducing variability before AI classification.

**Nodes involved:**
- **Normalize Intake Data**

#### Node: Normalize Intake Data
- **Type / role:** `Set` — normalize/rename/format intake fields.
- **Configuration (interpreted):**
  - Parameters are empty in the JSON; in practice you would:
    - Map raw webhook fields to canonical fields (e.g., `lead.email`, `lead.name`, `lead.serviceType`, `lead.message`)
    - Clean values (trim strings, normalize phone, lowercase email, etc.)
- **Connections:**
  - **Input ←** Workflow Configuration
  - **Output →** AI Lead Classifier
- **Failure/edge cases:**
  - Missing/empty fields → weaker AI classification and routing errors
  - If you rely on expressions like `{{$json.email}}` and it doesn’t exist, downstream nodes may error or produce blank outputs
- **Version:** typeVersion **3.4**

---

### Block 3 — AI Qualification & Structured Classification
**Overview:** Uses an OpenAI chat model plus a structured output parser to classify the lead (quality, service type, urgency, etc.) in a machine-consumable format, produced by an AI Agent node.

**Nodes involved:**
- **OpenAI Model - Lead Classifier**
- **Lead Classification Schema**
- **AI Lead Classifier**

#### Node: OpenAI Model - Lead Classifier
- **Type / role:** `lmChatOpenAi` (LangChain OpenAI Chat Model) — provides the LLM to the agent.
- **Configuration (interpreted):**
  - Parameters are empty in JSON; must be configured in n8n:
    - Model: per title, likely **GPT‑4.1-mini**
    - Credentials: OpenAI API key
    - Temperature/top_p as desired for deterministic classification (often low temperature)
- **Connections:**
  - **ai_languageModel →** AI Lead Classifier
- **Failure/edge cases:**
  - Missing/invalid OpenAI credentials
  - Model not available in your OpenAI account/region
  - Rate limits / timeouts during peak intake
- **Version:** typeVersion **1.3**

#### Node: Lead Classification Schema
- **Type / role:** `outputParserStructured` — enforces a structured JSON schema for the agent’s output.
- **Configuration (interpreted):**
  - Parameters are empty in JSON; normally you define:
    - A JSON schema (fields like `isQualified`, `serviceType`, `urgency`, `confidence`, `reasoningSummary`, etc.)
- **Connections:**
  - **ai_outputParser →** AI Lead Classifier
- **Failure/edge cases:**
  - If the model output cannot be parsed into the schema, the agent step fails
  - Overly strict schema increases parse failures; too loose reduces reliability
- **Version:** typeVersion **1.3**

#### Node: AI Lead Classifier
- **Type / role:** `agent` (LangChain Agent) — orchestrates prompt + model + structured parsing to produce classification fields used for routing.
- **Configuration (interpreted):**
  - Parameters are empty in JSON; typically includes:
    - System/user prompt describing how to classify leads and output required fields
    - Use of the attached language model and output parser connections
- **Key expressions / variables:**
  - Would typically reference normalized fields, e.g. `{{$json.lead.message}}`, `{{$json.lead.serviceRequested}}`
- **Connections:**
  - **Input ←** Normalize Intake Data
  - **Uses (via special ports):**
    - **ai_languageModel ←** OpenAI Model - Lead Classifier
    - **ai_outputParser ←** Lead Classification Schema
  - **Main Output →** Filter Lead Quality
- **Failure/edge cases:**
  - Prompt not aligned with schema → parsing errors
  - Missing lead text fields → low-quality classifications
- **Version:** typeVersion **3**

---

### Block 4 — Quality Gate & Service Routing
**Overview:** Filters out unqualified leads (or branches them) and routes qualified leads to the correct Slack notification path depending on service type.

**Nodes involved:**
- **Filter Lead Quality**
- **Route by Service Type**
- **Notify Team - Consulting**
- **Notify Team - Accounting**
- **Notify Team - Fractional CFO**

#### Node: Filter Lead Quality
- **Type / role:** `IF` — checks whether the lead meets qualification criteria.
- **Configuration (interpreted):**
  - Parameters are empty; you must define conditions such as:
    - `{{$json.isQualified}} = true` or `{{$json.qualificationScore}} >= X`
- **Connections:**
  - **Input ←** AI Lead Classifier
  - **Output (true path) →** Route by Service Type  
  - (No false-path connection is defined in JSON; unqualified leads currently go nowhere.)
- **Failure/edge cases:**
  - Missing classification fields → IF evaluation may fail or default false
  - No handling for unqualified leads (no logging, no polite rejection, etc.)
- **Version:** typeVersion **2.3**

#### Node: Route by Service Type
- **Type / role:** `Switch` — routes to a Slack notification based on classified service type.
- **Configuration (interpreted):**
  - Parameters empty; define cases such as:
    - `serviceType == "Consulting"`
    - `serviceType == "Accounting"`
    - `serviceType == "Fractional CFO"`
- **Connections:**
  - **Input ←** Filter Lead Quality
  - **Outputs →**
    - Output 0 → Notify Team - Consulting
    - Output 1 → Notify Team - Accounting
    - Output 2 → Notify Team - Fractional CFO
- **Failure/edge cases:**
  - Unexpected service type string → no matching route (and the lead is dropped)
  - Case-sensitivity/whitespace issues; normalize serviceType before switching
- **Version:** typeVersion **3.4**

#### Node: Notify Team - Consulting / Accounting / Fractional CFO
- **Type / role:** `Slack` — posts a message to a Slack channel for the relevant team.
- **Configuration (interpreted):**
  - Parameters empty; you must set:
    - Operation: “Post message”
    - Channel
    - Message content (include lead summary + AI classification)
    - Slack credentials (OAuth2/bot token)
- **Connections:**
  - **Each input ←** Route by Service Type (respective output)
  - **Each output →** Log Qualified Lead
- **Failure/edge cases:**
  - Slack auth revoked / missing scopes (`chat:write`)
  - Channel ID/name wrong or bot not in channel
- **Version:** typeVersion **2.4**

---

### Block 5 — Lead Logging & Client Acknowledgment
**Overview:** Logs the qualified lead into Google Sheets, generates a personalized acknowledgment email using an OpenAI model via an agent, and sends it through Gmail.

**Nodes involved:**
- **Log Qualified Lead**
- **OpenAI Model - Email Writer**
- **Generate Client Acknowledgment**
- **Send Acknowledgment Email**

#### Node: Log Qualified Lead
- **Type / role:** `Google Sheets` — appends lead data into a sheet for tracking.
- **Configuration (interpreted):**
  - Parameters empty; must configure:
    - Credentials (Google OAuth2 / Service Account depending on n8n setup)
    - Spreadsheet ID and Sheet/Tab
    - Operation (commonly “Append”)
    - Column mapping (name, email, company, serviceType, urgency, notes, timestamp, etc.)
- **Connections:**
  - **Input ←** each Slack notify node
  - **Output →** Generate Client Acknowledgment
- **Failure/edge cases:**
  - Spreadsheet permission errors
  - Column mismatch causing append failures
  - API quotas
- **Version:** typeVersion **4.7**

#### Node: OpenAI Model - Email Writer
- **Type / role:** `lmChatOpenAi` — LLM for generating the acknowledgment email.
- **Configuration (interpreted):**
  - Parameters empty; typically:
    - Model: GPT‑4.1-mini (per workflow title)
    - Low temperature for consistent professional tone
    - OpenAI credentials
- **Connections:**
  - **ai_languageModel →** Generate Client Acknowledgment
- **Failure/edge cases:**
  - Same as other OpenAI model node (auth/rate limits/model availability)
- **Version:** typeVersion **1.3**

#### Node: Generate Client Acknowledgment
- **Type / role:** `agent` — creates email subject/body based on lead info and classification.
- **Configuration (interpreted):**
  - Parameters empty; should include:
    - Prompt that produces:
      - `subject`
      - `body` (plain text or HTML)
      - optionally `nextSteps`, `calendarLink`, etc.
- **Connections:**
  - **Input ←** Log Qualified Lead
  - **ai_languageModel ←** OpenAI Model - Email Writer
  - **Main Output →** Send Acknowledgment Email
- **Failure/edge cases:**
  - If output is not mapped cleanly to Gmail fields, email node may send blank subject/body
- **Version:** typeVersion **3**

#### Node: Send Acknowledgment Email
- **Type / role:** `Gmail` — sends an acknowledgment to the lead.
- **Configuration (interpreted):**
  - Parameters empty; must configure:
    - Operation: “Send”
    - To: lead email (e.g., `{{$json.lead.email}}`)
    - Subject/body from agent output
    - From/sender identity (via Gmail credential)
- **Connections:**
  - **Input ←** Generate Client Acknowledgment
  - **Output →** Check High Urgency
- **Failure/edge cases:**
  - Gmail credential not authorized, or “From” alias not permitted
  - Sending limits / spam policy issues
  - Missing recipient email
- **Version:** typeVersion **2.2**

---

### Block 6 — Urgency Escalation
**Overview:** If the AI marked the lead as high urgency, the workflow sends an executive Slack alert.

**Nodes involved:**
- **Check High Urgency**
- **Executive Alert - High Urgency**

#### Node: Check High Urgency
- **Type / role:** `IF` — checks urgency level/flag.
- **Configuration (interpreted):**
  - Parameters empty; should check something like:
    - `{{$json.urgency}} == "high"` or `{{$json.isHighUrgency}} == true`
- **Connections:**
  - **Input ←** Send Acknowledgment Email
  - **Output (true path) →** Executive Alert - High Urgency
- **Failure/edge cases:**
  - If urgency field missing/renamed, escalation won’t happen
- **Version:** typeVersion **2.3**

#### Node: Executive Alert - High Urgency
- **Type / role:** `Slack` — posts an executive escalation message.
- **Configuration (interpreted):**
  - Parameters empty; configure:
    - Channel (e.g., `#exec-alerts`)
    - Message content (lead + why urgent + contact details)
    - Slack credentials
- **Connections:**
  - **Input ←** Check High Urgency
- **Failure/edge cases:**
  - Same Slack auth/scope/channel membership issues as other Slack nodes
- **Version:** typeVersion **2.4**

---

### Sticky Notes
There are 5 Sticky Note nodes present, but **all have empty content** in the JSON. They do not affect execution.

Nodes:
- Sticky Note
- Sticky Note1
- Sticky Note2
- Sticky Note3
- Sticky Note4

---

## 3. Summary Table

| Node Name | Node Type | Functional Role | Input Node(s) | Output Node(s) | Sticky Note |
|---|---|---|---|---|---|
| Client Intake Form | Webhook | Entry point for lead submissions | — | Workflow Configuration |  |
| Workflow Configuration | Set | Define constants / initial mapping | Client Intake Form | Normalize Intake Data |  |
| Normalize Intake Data | Set | Standardize incoming fields | Workflow Configuration | AI Lead Classifier |  |
| OpenAI Model - Lead Classifier | LangChain OpenAI Chat Model | LLM for lead classification | — | AI Lead Classifier (ai_languageModel) |  |
| Lead Classification Schema | Structured Output Parser | Enforce structured classifier output | — | AI Lead Classifier (ai_outputParser) |  |
| AI Lead Classifier | LangChain Agent | Classify/qualify lead (structured) | Normalize Intake Data | Filter Lead Quality |  |
| Filter Lead Quality | IF | Gate: qualified vs not | AI Lead Classifier | Route by Service Type |  |
| Route by Service Type | Switch | Route by service line | Filter Lead Quality | Notify Team - Consulting; Notify Team - Accounting; Notify Team - Fractional CFO |  |
| Notify Team - Consulting | Slack | Notify consulting channel | Route by Service Type | Log Qualified Lead |  |
| Notify Team - Accounting | Slack | Notify accounting channel | Route by Service Type | Log Qualified Lead |  |
| Notify Team - Fractional CFO | Slack | Notify CFO channel | Route by Service Type | Log Qualified Lead |  |
| Log Qualified Lead | Google Sheets | Append qualified lead record | Notify Team - Consulting; Notify Team - Accounting; Notify Team - Fractional CFO | Generate Client Acknowledgment |  |
| OpenAI Model - Email Writer | LangChain OpenAI Chat Model | LLM for acknowledgment email drafting | — | Generate Client Acknowledgment (ai_languageModel) |  |
| Generate Client Acknowledgment | LangChain Agent | Generate subject/body for acknowledgment | Log Qualified Lead | Send Acknowledgment Email |  |
| Send Acknowledgment Email | Gmail | Email the lead | Generate Client Acknowledgment | Check High Urgency |  |
| Check High Urgency | IF | Gate: urgency escalation | Send Acknowledgment Email | Executive Alert - High Urgency |  |
| Executive Alert - High Urgency | Slack | Executive escalation message | Check High Urgency | — |  |
| Sticky Note | Sticky Note | Comment container (empty) | — | — |  |
| Sticky Note1 | Sticky Note | Comment container (empty) | — | — |  |
| Sticky Note2 | Sticky Note | Comment container (empty) | — | — |  |
| Sticky Note3 | Sticky Note | Comment container (empty) | — | — |  |
| Sticky Note4 | Sticky Note | Comment container (empty) | — | — |  |

---

## 4. Reproducing the Workflow from Scratch

1. **Create a Webhook node** named **“Client Intake Form”**
   - Method: `POST`
   - Path: choose a stable path like `/client-intake`
   - Response: to reduce latency, prefer “Respond immediately” (or respond with a simple confirmation JSON)

2. **Add a Set node** named **“Workflow Configuration”**
   - Add fields you want as constants, for example:
     - `sheetId`, `sheetTab`
     - `slackChannelConsulting`, `slackChannelAccounting`, `slackChannelCFO`, `slackChannelExec`
     - `qualificationThreshold` (if using score-based)
   - Connect: **Client Intake Form → Workflow Configuration**

3. **Add a Set node** named **“Normalize Intake Data”**
   - Map webhook payload into a stable structure (example fields):
     - `lead.name`
     - `lead.email`
     - `lead.company`
     - `lead.serviceRequested`
     - `lead.message`
     - `lead.budget`
     - `lead.timeline`
     - `lead.createdAt` = now()
   - Connect: **Workflow Configuration → Normalize Intake Data**

4. **Add an OpenAI Chat Model node** named **“OpenAI Model - Lead Classifier”**
   - Select model: **GPT‑4.1-mini** (or the closest available in your n8n/OpenAI integration)
   - Credentials: create/select **OpenAI API** credential
   - Optionally set temperature low (e.g., 0–0.3) for consistency

5. **Add a Structured Output Parser node** named **“Lead Classification Schema”**
   - Define a schema (example conceptually):
     - `isQualified` (boolean)
     - `serviceType` (enum: Consulting/Accounting/Fractional CFO)
     - `urgency` (enum: low/medium/high)
     - `summary` (string)
     - `confidence` (number 0–1)
   - Keep schema aligned with how you plan to route in later nodes.

6. **Add an AI Agent node** named **“AI Lead Classifier”**
   - Configure prompt to:
     - Evaluate lead fit
     - Select `serviceType`
     - Determine `urgency`
     - Output exactly the schema fields
   - Connect special ports:
     - **OpenAI Model - Lead Classifier → AI Lead Classifier (ai_languageModel)**
     - **Lead Classification Schema → AI Lead Classifier (ai_outputParser)**
   - Connect main flow:
     - **Normalize Intake Data → AI Lead Classifier**

7. **Add an IF node** named **“Filter Lead Quality”**
   - Condition example: `isQualified` equals `true`
   - Connect: **AI Lead Classifier → Filter Lead Quality**
   - (Optional but recommended) Use the **false** branch to log “unqualified” somewhere or notify a different channel.

8. **Add a Switch node** named **“Route by Service Type”**
   - Value to evaluate: `serviceType`
   - Cases:
     1) “Consulting” → output 0  
     2) “Accounting” → output 1  
     3) “Fractional CFO” → output 2  
   - Connect: **Filter Lead Quality (true) → Route by Service Type**

9. **Add three Slack nodes** (operation: Post Message)
   - **Notify Team - Consulting**
   - **Notify Team - Accounting**
   - **Notify Team - Fractional CFO**
   - Configure Slack credentials (OAuth2/bot token) with `chat:write`
   - Set each node’s target channel appropriately
   - Message template should include lead contact + summary + urgency
   - Connect:
     - **Route by Service Type output 0 → Notify Team - Consulting**
     - **output 1 → Notify Team - Accounting**
     - **output 2 → Notify Team - Fractional CFO**

10. **Add a Google Sheets node** named **“Log Qualified Lead”**
   - Credentials: Google OAuth2 (or Service Account)
   - Operation: Append row
   - Spreadsheet: use `sheetId` (from config) or hardcode
   - Map columns from lead + classification fields
   - Connect:
     - **Notify Team - Consulting → Log Qualified Lead**
     - **Notify Team - Accounting → Log Qualified Lead**
     - **Notify Team - Fractional CFO → Log Qualified Lead**

11. **Add an OpenAI Chat Model node** named **“OpenAI Model - Email Writer”**
   - Model: GPT‑4.1-mini (or equivalent)
   - Credentials: OpenAI API credential
   - Temperature moderate-low for professional tone

12. **Add an AI Agent node** named **“Generate Client Acknowledgment”**
   - Prompt: generate `subject` and `body` (and optionally `bodyHtml`) acknowledging receipt and setting expectations.
   - Connect:
     - **Log Qualified Lead → Generate Client Acknowledgment**
     - **OpenAI Model - Email Writer → Generate Client Acknowledgment (ai_languageModel)**

13. **Add a Gmail node** named **“Send Acknowledgment Email”**
   - Credentials: Gmail OAuth2
   - Operation: Send
   - To: `lead.email`
   - Subject: from agent output
   - Body: from agent output
   - Connect: **Generate Client Acknowledgment → Send Acknowledgment Email**

14. **Add an IF node** named **“Check High Urgency”**
   - Condition example: `urgency` equals `high`
   - Connect: **Send Acknowledgment Email → Check High Urgency**

15. **Add a Slack node** named **“Executive Alert - High Urgency”**
   - Operation: Post Message to exec channel
   - Include: lead contact, urgency rationale, recommended next action
   - Connect: **Check High Urgency (true) → Executive Alert - High Urgency**

16. **(Optional) Add Sticky Notes**
   - In the provided workflow they exist but contain no content; they’re not required.

---

## 5. General Notes & Resources

| Note Content | Context or Link |
|---|---|
| Workflow sticky notes are present but empty; they do not document business rules or field mappings. | Applies to Sticky Note, Sticky Note1–4 |
| Many nodes have empty parameters in the provided JSON; the workflow’s behavior depends on prompts, schemas, IF/Switch conditions, and credential setup that must be defined in n8n. | Applies to Set/IF/Switch/OpenAI/Slack/Sheets/Gmail nodes |

Disclaimer (as provided): Le texte fourni provient exclusivement d’un workflow automatisé réalisé avec n8n, un outil d’intégration et d’automatisation. Ce traitement respecte strictement les politiques de contenu en vigueur et ne contient aucun élément illégal, offensant ou protégé. Toutes les données manipulées sont légales et publiques.